meta-product=routines_os
meta-description="Waffle W1 Nerves System"
meta-version="0.0.0-alpha.0"
meta-author="Eliel A. Gordon"
meta-platform=Waffle
meta-architecture=arm
require-fwup-version=1.0.0
file-resource "uboot_env" {
length=2097152
blake2b-256=35fe059b3666b579d36207988ce62f296a6800ea1987c2be82cf66c96b22e7ed
}
file-resource "kernel_dtb" {
length=49408
blake2b-256=601e809cb10b961753d0c5b8b3278e9acd08cb48efe5a12e0b99121c739a0c8c
}
file-resource "kernel_Image" {
length=12857608
blake2b-256=cdbad9a61f3d2bcffddf88e782048a1d2742bfd5984355d84f1d4bb4235cd627
}
file-resource "rootfs" {
length=42708992
blake2b-256=90de25d678affd1c2d534e883555940e09fae9ec6d863918bdf2c6cf2064253d
}
task "complete" {
on-init {
funlist={2,uboot_clearenv,"uboot-env",4,uboot_setenv,"uboot-env",nerves_fw_devpath,"/dev/mmcblk0",4,uboot_setenv,"uboot-env",b.nerves_fw_application_part0_devpath,"/dev/mmcblk0p9",4,uboot_setenv,"uboot-env",b.nerves_fw_application_part0_fstype,f2fs,4,uboot_setenv,"uboot-env",b.nerves_fw_application_part0_target,"/root",4,uboot_setenv,"uboot-env",b.nerves_fw_product,routines_os,4,uboot_setenv,"uboot-env",b.nerves_fw_description,"Waffle W1 Nerves System",4,uboot_setenv,"uboot-env",b.nerves_fw_version,"0.0.0-alpha.0",4,uboot_setenv,"uboot-env",b.nerves_fw_platform,Waffle,4,uboot_setenv,"uboot-env",b.nerves_fw_architecture,arm,4,uboot_setenv,"uboot-env",b.nerves_fw_author,"Eliel A. Gordon",4,uboot_setenv,"uboot-env",b.nerves_fw_vcs_identifier,"",4,uboot_setenv,"uboot-env",b.nerves_fw_misc,"",4,uboot_setenv,"uboot-env",b.nerves_fw_uuid,"${FWUP_META_UUID}",2,execute,"bootenv -s /dev/mmcblk0p3 /kernel_meta partition kernel-B",2,execute,"bootenv -s /dev/mmcblk0p3 /rootfs_meta partition rootfs-B",2,execute,"bootenv -s /dev/mmcblk0p3 / cmdline \"console=ttyS0 panic=1 earlycon loglevel=7 noinitrd root=/dev/mmcblk0p8 ro rootfstype=squashfs rootwait init=/sbin/init random.trust_cpu=on random.trust_bootloader=on\"",2,execute,"bootenv -s /dev/mmcblk0p3 / update_state U",4,uboot_setenv,"uboot-env",nerves_fw_active,b}
}
on-resource "kernel_dtb" {
funlist={2,raw_write,16384}
}
on-resource "kernel_Image" {
funlist={2,raw_write,53248}
}
on-resource "rootfs" {
funlist={2,raw_write,1134592}
}
}
task "upgrade.a" {
reqlist={4,"require-uboot-variable","uboot-env",nerves_fw_active,b,4,"require-uboot-variable","uboot-env",b.nerves_fw_platform,Waffle,4,"require-uboot-variable","uboot-env",b.nerves_fw_architecture,arm}
on-finish {
funlist={4,uboot_setenv,"uboot-env",nerves_fw_devpath,"/dev/mmcblk0",4,uboot_setenv,"uboot-env",a.nerves_fw_application_part0_devpath,"/dev/mmcblk0p9",4,uboot_setenv,"uboot-env",a.nerves_fw_application_part0_fstype,f2fs,4,uboot_setenv,"uboot-env",a.nerves_fw_application_part0_target,"/root",4,uboot_setenv,"uboot-env",a.nerves_fw_product,routines_os,4,uboot_setenv,"uboot-env",a.nerves_fw_description,"Waffle W1 Nerves System",4,uboot_setenv,"uboot-env",a.nerves_fw_version,"0.0.0-alpha.0",4,uboot_setenv,"uboot-env",a.nerves_fw_platform,Waffle,4,uboot_setenv,"uboot-env",a.nerves_fw_architecture,arm,4,uboot_setenv,"uboot-env",a.nerves_fw_author,"Eliel A. Gordon",4,uboot_setenv,"uboot-env",a.nerves_fw_vcs_identifier,"",4,uboot_setenv,"uboot-env",a.nerves_fw_misc,"",4,uboot_setenv,"uboot-env",a.nerves_fw_uuid,"${FWUP_META_UUID}",2,execute,"bootenv -s /dev/mmcblk0p3 /fallback rootfs_partition rootfs-B",2,execute,"bootenv -s /dev/mmcblk0p3 /fallback kernel_partition kernel-B",2,execute,"bootenv -s /dev/mmcblk0p3 /fallback cmdline \"console=ttyS0 panic=1 earlycon loglevel=7 noinitrd root=/dev/mmcblk0p8 ro rootfstype=squashfs rootwait init=/sbin/init random.trust_cpu=on random.trust_bootloader=on\"",2,execute,"bootenv -s /dev/mmcblk0p3 /kernel_meta partition kernel-A",2,execute,"bootenv -s /dev/mmcblk0p3 /rootfs_meta partition rootfs-A",2,execute,"bootenv -s /dev/mmcblk0p3 / cmdline \"console=ttyS0 panic=1 earlycon loglevel=7 noinitrd root=/dev/mmcblk0p7 ro rootfstype=squashfs rootwait init=/sbin/init random.trust_cpu=on random.trust_bootloader=on\"",2,execute,"bootenv -s /dev/mmcblk0p3 / update_state U",4,uboot_setenv,"uboot-env",nerves_fw_active,a}
}
on-resource "kernel_dtb" {
funlist={2,raw_write,16384}
}
on-resource "kernel_Image" {
delta-source-raw-offset=53248
delta-source-raw-count=32768
funlist={2,raw_write,20480}
}
on-resource "rootfs" {
delta-source-raw-offset=1134592
delta-source-raw-count=1048576
funlist={2,raw_write,86016}
}
}
task "upgrade.b" {
reqlist={4,"require-uboot-variable","uboot-env",nerves_fw_active,a,4,"require-uboot-variable","uboot-env",b.nerves_fw_platform,Waffle,4,"require-uboot-variable","uboot-env",b.nerves_fw_architecture,arm}
on-finish {
funlist={4,uboot_setenv,"uboot-env",nerves_fw_devpath,"/dev/mmcblk0",4,uboot_setenv,"uboot-env",b.nerves_fw_application_part0_devpath,"/dev/mmcblk0p9",4,uboot_setenv,"uboot-env",b.nerves_fw_application_part0_fstype,f2fs,4,uboot_setenv,"uboot-env",b.nerves_fw_application_part0_target,"/root",4,uboot_setenv,"uboot-env",b.nerves_fw_product,routines_os,4,uboot_setenv,"uboot-env",b.nerves_fw_description,"Waffle W1 Nerves System",4,uboot_setenv,"uboot-env",b.nerves_fw_version,"0.0.0-alpha.0",4,uboot_setenv,"uboot-env",b.nerves_fw_platform,Waffle,4,uboot_setenv,"uboot-env",b.nerves_fw_architecture,arm,4,uboot_setenv,"uboot-env",b.nerves_fw_author,"Eliel A. Gordon",4,uboot_setenv,"uboot-env",b.nerves_fw_vcs_identifier,"",4,uboot_setenv,"uboot-env",b.nerves_fw_misc,"",4,uboot_setenv,"uboot-env",b.nerves_fw_uuid,"${FWUP_META_UUID}",2,execute,"bootenv -s /dev/mmcblk0p3 /fallback rootfs_partition rootfs-A",2,execute,"bootenv -s /dev/mmcblk0p3 /fallback kernel_partition kernel-A",2,execute,"bootenv -s /dev/mmcblk0p3 /fallback cmdline \"console=ttyS0 panic=1 earlycon loglevel=7 noinitrd root=/dev/mmcblk0p7 ro rootfstype=squashfs rootwait init=/sbin/init random.trust_cpu=on random.trust_bootloader=on\"",2,execute,"bootenv -s /dev/mmcblk0p3 /kernel_meta partition kernel-B",2,execute,"bootenv -s /dev/mmcblk0p3 /rootfs_meta partition rootfs-B",2,execute,"bootenv -s /dev/mmcblk0p3 / cmdline \"console=ttyS0 panic=1 earlycon loglevel=7 noinitrd root=/dev/mmcblk0p8 ro rootfstype=squashfs rootwait init=/sbin/init random.trust_cpu=on random.trust_bootloader=on\"",2,execute,"bootenv -s /dev/mmcblk0p3 / update_state U",4,uboot_setenv,"uboot-env",nerves_fw_active,b}
}
on-resource "kernel_dtb" {
funlist={2,raw_write,16384}
}
on-resource "kernel_Image" {
delta-source-raw-offset=20480
delta-source-raw-count=32768
funlist={2,raw_write,53248}
}
on-resource "rootfs" {
delta-source-raw-offset=20480
delta-source-raw-count=32768
funlist={2,raw_write,1134592}
}
}
task "upgrade.unexpected" {
reqlist={4,"require-uboot-variable","uboot-env",a.nerves_fw_platform,Waffle,4,"require-uboot-variable","uboot-env",a.nerves_fw_architecture,arm}
on-init {
funlist={2,error,"Please check the media being upgraded. It doesn't look like either the A or B partitions are active."}
}
}
task "upgrade.wrongplatform" {
on-init {
funlist={2,error,"Expecting platform=Waffle and architecture=arm"}
}
}
uboot-environment "uboot-env" {
block-offset=27348992
block-count=4096
}
